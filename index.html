<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
		<title>Tresoar viewer</title>
		<link rel="stylesheet" href="assets/ol.css">
		<link rel="stylesheet" href="assets/viewer.css">
		<script src="assets/proj4.js" type="text/javascript"></script>
		<script src="assets/ol-debug.js"></script>
		<script src="assets/jquery-2.2.0.min.js"></script>
		<script src="assets/transparency.min.js"></script>
	</head>
	<body>
		<div id="header">
			<h1>Tresoar</h1>
		</div>
		
		<div id="map" class="map"></div>

		<div id="layers">
			<ul class="layers">
				<li class="layer">
					<label>
						<input type="checkbox" name="toggle">
						<span class="layer-name"></span>
					</label>
					<input type="range" name="opacity" min="0" max="100" value="100">
				</li>
			</ul>
		</div>

		<script>
			"use strict"

			proj4.defs("EPSG:28992", "+proj=sterea +lat_0=52.15616055555555 +lon_0=5.38763888888889 +k=0.9999079 +x_0=155000 +y_0=463000  +ellps=bessel  +towgs84=565.040,49.910,465.840,-0.40939,0.35971,-1.86849,4.0772 +units=m +no_defs");
		
			var EPSG28992 = new ol.proj.Projection({
				code: 'EPSG:28992'
			});
			
			ol.proj.addProjection(EPSG28992);
			
			var projection = EPSG28992;
			var projectionExtent = [-285401.92,22598.08,595401.9199999999,903401.9199999999];
			var size = ol.extent.getWidth(projectionExtent) / 256;
			var resolutions = [3440.64, 1720.32, 860.16, 430.08, 215.04, 107.52, 53.76, 26.88, 13.44, 6.72, 3.36, 1.68, 0.84, 0.42]
			
			// generate resolutions and matrixIds arrays for this WMTS
			var matrixIds = new Array(resolutions.length);
			for (var z = 0; z < matrixIds.length; ++z) {
				matrixIds[z] = 'EPSG:28992:' + z;
			}

			//FIXME this is ugly 
			//generate resolutions and matrixIds for luchtfoto
			var matrixIds2 = [];
			for (var i = 0;
				i <= 13;
				++i) {
			 		if (i < 10) {
			        	matrixIds2[i] = "0" + i;
			 		} else {
			 	    	 matrixIds2[i] = "" + i;
					}
			}

			// FIXME it would be more awesome if we could retrieve this list (excl the base layers)
			// from Geoserver directly (through GetCapabilities?)
			
			// Could we then also access the extents of each layer? Then we can filter the list by
			// intersecting those with the current view extents.
			var layers = {
				brt: new ol.layer.Tile({
					extent: projectionExtent,
					source: new ol.source.WMTS({
						url: 'http://geodata.nationaalgeoregister.nl/tiles/service/wmts/brtachtergrondkaart',
						layer: 'brtachtergrondkaart',
						matrixSet: 'EPSG:28992',
						format: 'image/png',
						attributions: [new ol.Attribution({
              			html: 'Kaartgegevens: © <a href="http://www.cbs.nl">CBS</a>, <a href="http://www.kadaster.nl">Kadaster</a>, <a href="http://openstreetmap.org">OpenStreetMap Bijdragers</a><span class="printhide"> (<a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>)' +
              			' Kaartviewer: <a href="http://rug.nl/geo">Geodienst RUG</a>'
            			})],
            			layertitle: 'Kaart',
						projection: projection,
						tileGrid: new ol.tilegrid.WMTS({
							origin: ol.extent.getTopLeft(projectionExtent),
							resolutions: resolutions,
							matrixIds: matrixIds
						})
					})
				}),

				lufo: new ol.layer.Tile({
					extent: projectionExtent,
					source: new ol.source.WMTS({
						url: 'http://geodata1.nationaalgeoregister.nl/luchtfoto/wmts',
						service: 'WMTS',
						version: "1.0.0",
						layer: 'luchtfoto',
						matrixSet: 'nltilingschema',
						format: 'image/jpeg',
						style: '',
						attributions: [new ol.Attribution({
              			html: 'Luchtfoto: <a href="https://www.pdok.nl/nl/copyright/luchtfotos/" target="_blank">© PDOK CC-BY-NC</a>'+
              			' Kaartviewer: <a href="http://rug.nl/geo">Geodienst RUG</a>'
            			})],
            			layertitle:'Luchtfoto',
						projection: projection,
						visibility: true,
						zoomOffset: 2,
						tileGrid: new ol.tilegrid.WMTS({
							origin: ol.extent.getTopLeft(projectionExtent),
							resolutions: resolutions,
							matrixIds: matrixIds2
						})
					})
				}),

				// FIXME figure out how to get access to the extents layer, and if we can't get a list of
				// extents from all the layers through Geoserver, we need access to all individual extents
				// defined in this layer.
				extents: new ol.layer.Tile({
					source: new ol.source.WMTS({
						url: 'http://geoserver.ikhoefgeen.nl/geoserver/gwc/service/wmts',
						layer: 'geodienst:extents',
						matrixSet: 'EPSG:28992',
						format: 'image/png',
						layertitle: 'extents',
						projection: projection,
						tileGrid: new ol.tilegrid.WMTS({
							origin: ol.extent.getTopLeft(projectionExtent),
							resolutions: resolutions,
							matrixIds: matrixIds
						})
					})
				})
			};

			var map = new ol.Map({
				maxExtent: projectionExtent,
				layers: [layers.brt],
				target: 'map',
				maxResolution: 860.16,
				numZoomLevels: 12,
				units: 'm',
				theme: null,
				displayProjection: EPSG28992,
				view: new ol.View({
					projection: EPSG28992,
					center: ol.extent.getCenter(projectionExtent),
					zoom: 9
				})
			});

			// Render the list of layers (using Transparency.js templating)
			$('#layers').render(
				{ // values
					layers: $.map(layers, function(layer, layerId) {
						return {
							layer: {
								'id': layerId,
								'layer-name': layerId
							}
						};
					})
				},
				{ // directives on how to render this stuff
					'layers': {
						'layer': {
							'data-layer-id': function() {
								return this.layer.id;
							}
						},
						'toggle': {
							'checked': function () {
								return map.getLayers().getArray().indexOf(layers[this.layer.id]) !== -1;
							},
							'value': function () {
								return this.layer.id;
							}
						}
					}
				}
			);

			// Make stuff interactive

			$('#layers').on('change', '.layer input[name=toggle]', function(e) {
				if (this.checked) {
					map.addLayer(layers[this.value]);
				} else {
					map.removeLayer(layers[this.value]);
				}
			});

			$('#layers').on('change', '.layer input[name=opacity]', function(e) {
				var layerId = $(this).closest('.layer').data('layerId');
				layers[layerId].setOpacity(this.value / 100);
			});

			var geolocation = new ol.Geolocation({
  // take the projection to use from the map's view
  projection: view.getProjection()
});
// listen to changes in position
geolocation.on('change', function(evt) {
  window.console.log(geolocation.getPosition());
});
		</script>
	</body>
</html>